% Homogeneous covariance among random effects terms
% Andrey Ziyatdinov
% 14/09/2014

```{r setup, include = FALSE}
opts_chunk$set(fig.path = 'figure/', cache.path = 'cache/', echo = TRUE, 
  cache = FALSE, tidy = FALSE,
  fig.width = 9, fig.height = 9, dev = 'png', fig.cap = "",
  warning = FALSE, message = FALSE)
opts_knit$set(upload.fun = identity)
```

```{r, warning = FALSE, message = FALSE}
library(ascii)
```

```{r}
output.HTML <- TRUE

my_ascii <- function(x, ...) 
{
  require(ascii)

  if(output.HTML) {
    y <- capture.output(print(ascii(x, ...)))

    cat("\n")
    cat(writeLines(y))
    cat("\n")
  } else {

    y <- capture.output(print(ascii(x, ...), type = "org"))
    # substitute + with | for table markup
    # TODO: modify regex so that only + signs in markup,
    #   like -+- are substituted
    y <- gsub("[+]", "|", y)

    cat("\n")
    cat(writeLines(y))
    cat("\n")
  }    

  return(invisible())
}
```

## About

This report aims to reproduce an example in the article 
[Fitting Linear Mixed-Effects Models using lme4](http://arxiv.org/abs/1406.5823), Appendix A.1.

The model under study has a form:

```
respVar ~ 1 + (explVar1|groupFac1) + (explVar2|groupFac2)
```

The model has two random terms, both including a random intercept and slopes.
Each random term contains a 2x2 covariance matrix.
The current version of `lme4` does not allows a model, where random terms share the same covariance matrices.
This example shows such a model thanks to the modular imlementation of the `lme4` package.

The `lme4` package version:

```{r}
library(lme4)
packageVersion("lme4")
```

## Data simulation

```{r, cache = TRUE}
set.seed(1)

nGrps <- 50

explVar <- data.frame(explVar1 = rnorm(nGrps^2), 
  explVar2 = rnorm(nGrps^2))

groupFac <- expand.grid(groupFac1 = as.factor(1:nGrps),
  groupFac2 = as.factor(1:nGrps))

randomIntercept <- expand.grid(randomIntercept1 = rnorm(nGrps),
  randomIntercept2 = rnorm(nGrps))
  
rnmdSlope <- expand.grid(randomSlope1 = rnorm(nGrps),
  randomSlope2 = rnorm(nGrps)) - randomIntercept
  
linearPredictor <- apply(randomIntercept + rnmdSlope*explVar, 1, sum)

residError <- rnorm(nGrps^2)

respVar <- linearPredictor + residError

dat <- data.frame(respVar, explVar, groupFac)

dim(dat)
head(dat)
```

## Default model

```{r, cache = TRUE}
mod1 <- lmer(respVar ~ 1 + (explVar1|groupFac1) + (explVar2|groupFac2), dat)
mod1
```

The `theta` model parameters are (expected to be of length `6`):

```
round(mod1@theta, 2)
```

The length of the vector of the random effects is (expected to be: 2 terms x 50 group levels x (slope + intercept) = `200`):

```{r}
length(mod1@u)
```

The relative covariance factor `Lambda`:

```{r}
dim(mod1@pp$Lambdat)
```

```{r}
mod1@pp$Lambdat[1:5, 1:5]
```


The number of non-zero elements in this matrix:

```{r}
length(mod1@pp$Lind)
```

### Modular call

```{r, cache = TRUE}
parsedFormula <- lFormula(formula = respVar ~ 1 + (explVar1|groupFac1) + (explVar2|groupFac2),
  data = dat)

devianceFunction <- do.call(mkLmerDevfun, parsedFormula)

optimizerOutput <- optimizeLmer(devianceFunction)

mod2 <- mkMerMod(rho = environment(devianceFunction),
  opt = optimizerOutput,
  reTrms = parsedFormula$reTrms,
  fr = parsedFormula$fr)
```

```{r}
mod2
```

## Extension

### Modular calls

```{r}
lfHetero <- lfHomo <- lFormula(respVar ~ 1 + (explVar1|groupFac1) + (explVar2|groupFac2), dat, REML = FALSE)
  
if(length(pRE <- unique(sapply(cnms <- lfHomo$reTrms$cnms, length))) > 1L) {
  stop("each random effects term must have the same number\n",
    "of model matrix columns for a homogeneous structure")
}
```

```{r}
p <- ncol(lfHomo$X)
nth <- choose(pRE + 1, 2)
n_trms <- length(cnms)
```

```{r}
tab <- ldply(1:3, function(pRE) data.frame(num_var_random_term = pRE, length_theta = choose(pRE + 1, 2)))
tab <- data.frame(tab, theta_names = c("sigma", "2 sigmas, 1 rho", "3 sigmas, 3 rhos"))
tab
```

```{r}
lfHomo$reTrms <- within(lfHomo$reTrms, {
  theta <- theta[1:nth]
  lower <- lower[1:nth]
  Lind <- rep(1:nth, length = length(lfHomo$reTrms$Lambdat@x))
})
```

```{r}
tab <- data.frame(length_theta = c(length(lfHetero$reTrms$theta), length(lfHomo$reTrms$theta)), 
  length_lower = c(length(lfHetero$reTrms$lower), length(lfHomo$reTrms$lower)),
  unique_Lind = c(paste(unique(lfHetero$reTrms$Lind), collapse = ", "), 
    paste(unique(lfHomo$reTrms$Lind), collapse = ", ")))
tab
```

### `homoLmer` function

```{r}
homoLmer <- function(formula, data, use.mkMerMod = FALSE) 
{
  mc <- match.call()

  lfHetero <- lfHomo <- lFormula(formula, data = data, REML = FALSE)
  
  if(length(pRE <- unique(sapply(cnms <- lfHomo$reTrms$cnms, length))) > 1L) {
    stop("each random effects term must have the same number\n",
      "of model matrix columns for a homogeneous structure")
  }
}
```

```{r}
mod4 <- homoLmer(respVar ~ 1 + (explVar1|groupFac1) + (explVar2|groupFac2), dat)
```


